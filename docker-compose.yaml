services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      CLAWBOARD_DB_URL: sqlite:///./data/clawboard.db
      CLAWBOARD_CORS_ORIGINS: "*"
      # CLAWBOARD_TOKEN is read from .env via env_file
    volumes:
      - ./data:/app/data
    ports:
      - "8010:8000"

  classifier:
    build:
      context: ./classifier
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      CLAWBOARD_API_BASE: http://api:8000
      OPENCLAW_BASE_URL: ${OPENCLAW_BASE_URL:-http://host.docker.internal:18789}
      OPENCLAW_MODEL: ${OPENCLAW_MODEL:-openai-codex/gpt-5.2}
      CLASSIFIER_INTERVAL_SECONDS: ${CLASSIFIER_INTERVAL_SECONDS:-10}
      CLASSIFIER_MAX_ATTEMPTS: ${CLASSIFIER_MAX_ATTEMPTS:-3}
    depends_on:
      - api
    volumes:
      - ./data:/data
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        # IMPORTANT: this value is baked into the browser bundle.
        # For remote (Tailscale) access, set CLAWBOARD_PUBLIC_API_BASE in .env
        NEXT_PUBLIC_CLAWBOARD_API_BASE: ${CLAWBOARD_PUBLIC_API_BASE:-http://localhost:8010}
    environment:
      # IMPORTANT: this is used client-side; must be reachable from the browser.
      NEXT_PUBLIC_CLAWBOARD_API_BASE: ${CLAWBOARD_PUBLIC_API_BASE:-http://localhost:8010}
    depends_on:
      - api
    ports:
      - "3010:3000"
