services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      CLAWBOARD_DB_URL: sqlite:///./data/clawboard.db
      CLAWBOARD_CORS_ORIGINS: "*"
      CLAWBOARD_REINDEX_QUEUE_PATH: /app/data/reindex-queue.jsonl
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-clawboard_embeddings}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      # CLAWBOARD_TOKEN is read from .env via env_file
    volumes:
      - ./data:/app/data
    ports:
      - "8010:8000"
    depends_on:
      - qdrant
    networks:
      - edge
      - core

  classifier:
    build:
      context: ./classifier
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      CLAWBOARD_API_BASE: http://api:8000
      OPENCLAW_BASE_URL: ${OPENCLAW_BASE_URL:-http://host.docker.internal:18789}
      OPENCLAW_MODEL: ${OPENCLAW_MODEL:-openai-codex/gpt-5.2}
      CLASSIFIER_INTERVAL_SECONDS: ${CLASSIFIER_INTERVAL_SECONDS:-10}
      CLASSIFIER_MAX_ATTEMPTS: ${CLASSIFIER_MAX_ATTEMPTS:-3}
      CLASSIFIER_WINDOW_SIZE: ${CLASSIFIER_WINDOW_SIZE:-24}
      CLASSIFIER_LOOKBACK_LOGS: ${CLASSIFIER_LOOKBACK_LOGS:-80}
      CLASSIFIER_TOPIC_SIM_THRESHOLD: ${CLASSIFIER_TOPIC_SIM_THRESHOLD:-0.78}
      CLASSIFIER_TASK_SIM_THRESHOLD: ${CLASSIFIER_TASK_SIM_THRESHOLD:-0.80}
      CLASSIFIER_EMBED_MODEL: ${CLASSIFIER_EMBED_MODEL:-BAAI/bge-small-en-v1.5}
      CLASSIFIER_REINDEX_QUEUE_PATH: /data/reindex-queue.jsonl
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-clawboard_embeddings}
      QDRANT_DIM: ${QDRANT_DIM:-384}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
    depends_on:
      - api
      - qdrant
    volumes:
      - ./data:/data
      - ${HOME}/.openclaw/memory:/data/openclaw-memory:ro
    restart: unless-stopped
    networks:
      - edge
      - core

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        # IMPORTANT: this value is baked into the browser bundle.
        # For remote (Tailscale) access, set CLAWBOARD_PUBLIC_API_BASE in .env
        NEXT_PUBLIC_CLAWBOARD_API_BASE: ${CLAWBOARD_PUBLIC_API_BASE:-http://localhost:8010}
        # Optional default UI token, also baked into browser bundle.
        NEXT_PUBLIC_CLAWBOARD_DEFAULT_TOKEN: ${NEXT_PUBLIC_CLAWBOARD_DEFAULT_TOKEN:-}
    environment:
      # IMPORTANT: this is used client-side; must be reachable from the browser.
      NEXT_PUBLIC_CLAWBOARD_API_BASE: ${CLAWBOARD_PUBLIC_API_BASE:-http://localhost:8010}
      NEXT_PUBLIC_CLAWBOARD_DEFAULT_TOKEN: ${NEXT_PUBLIC_CLAWBOARD_DEFAULT_TOKEN:-}
    depends_on:
      - api
    ports:
      - "3010:3000"
    networks:
      - edge

  db:
    image: postgres:16
    profiles: ["scale"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-clawboard}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-clawboard}
      POSTGRES_DB: ${POSTGRES_DB:-clawboard}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    expose:
      - "5432"
    networks:
      - core

  qdrant:
    image: qdrant/qdrant:latest
    volumes:
      - ./data/qdrant:/qdrant/storage
    expose:
      - "6333"
    networks:
      - core

  redis:
    image: redis:7-alpine
    profiles: ["scale"]
    expose:
      - "6379"
    networks:
      - core

networks:
  edge:
    driver: bridge
  core:
    driver: bridge
